<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="lib/onsenui/leaflet/leaflet.css">
  <link rel="stylesheet" href="lib/onsenui/leaflet-gps-master/leaflet-gps-master/src/leaflet-gps.css">
  <link rel="stylesheet" href="lib/onsenui/leaflet-routing-machine-3.2.12/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.css">
</head>
<body>
 
  <ons-splitter>
      <ons-splitter-side id="menu" side="left" width="220px" swipe-target-width="100px" collapse swipeable="force">
          <ons-page>
              <ons-list>
                  <ons-list-item onclick="fn.load('home.html')" tappable>Home</ons-list-item>
                  <ons-list-item onclick="fn.load('carte.html')" tappable>Carte</ons-list-item>
                  <ons-list-item onclick="fn.load('parcours.html')" tappable>Parcours</ons-list-item>
                  <ons-list-item onclick="fn.load('about.html')" tappable>About</ons-list-item>
              </ons-list>
          </ons-page>
      </ons-splitter-side>
      <ons-splitter-content id="content" page="home.html"></ons-splitter-content>
  </ons-splitter>
  
  <template id="home.html">
      <ons-page>
          <ons-toolbar>
              <div class="left">
                  <ons-toolbar-button onclick="fn.open()">
                      <ons-icon icon="md-menu"></ons-icon>
                  </ons-toolbar-button>
              </div>
              <div class="center">Main</div>
          </ons-toolbar>
          <p style="opacity: 0.6; padding-top: 20px;">Swipe right to open the menu!</p>
      </ons-page>
  </template>
  
  <template id="carte.html">
      <ons-page id="carte">
          <ons-toolbar>
              <div class="left">
                  <ons-toolbar-button onclick="fn.open()">
                      <ons-icon icon="md-menu"></ons-icon>
                  </ons-toolbar-button>
              </div>
              <div class="center">Carte interactive</div>
          </ons-toolbar>
          <br><br>
          <ons-search-input placeholder="Search..." modifier="material"></ons-search-input>
          <ons-list id="places_list">
          </ons-list>
          <p>Carte de Créteil : </p>
          <div id="mapid"></div>
      </ons-page>
  </template>
  
  <template id="parcours.html">
        
        <ons-navigator page="liste_parcours.html" animation="fade">
           <template id="liste_parcours.html">
               <ons-page id="parcours">
          <ons-toolbar>
              <div class="left">
                  <ons-toolbar-button onclick="fn.open()">
                      <ons-icon icon="md-menu"></ons-icon>
                  </ons-toolbar-button>
              </div>
              <div class="center">Types de parcours</div>
          </ons-toolbar>
          <ons-card></ons-card>
      </ons-page>
            </template>
            
            <template id="carte_parcours.html">
                <ons-page id="carte_parcours">
            <ons-toolbar>
                <div class="left">
                    <ons-back-button>Retour</ons-back-button>
                </div>
                <div class="center"></div>
            </ons-toolbar>
             <div id="map_parcours"></div>
         </ons-page>
            </template>
       
        </ons-navigator>
     
  </template>
  
  <template id="about.html">
      <ons-page>
          <ons-toolbar>
              <div class="left">
                  <ons-toolbar-button onclick="fn.open()">
                      <ons-icon icon="md-menu"></ons-icon>
                  </ons-toolbar-button>
              </div>
              <div class="center">About</div>
          </ons-toolbar>
      </ons-page>
    </template>
    
    <script src="lib/onsenui/leaflet/leaflet.js"></script>
    <script src="lib/onsenui/js/jquery-3.3.1.min.js"></script>
    <script src="lib/onsenui/leaflet-gps-master/leaflet-gps-master/src/leaflet-gps.js"></script>
    <script src="lib/onsenui/leaflet-routing-machine-3.2.12/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="lib/onsenui/leaflet-routing-machine-3.2.12/leaflet-routing-machine-3.2.12/examples/Control.Geocoder.js"></script>
  
  <script>
   
      window.fn = {};
      
      window.fn.open = function(){
          var menu = document.getElementById('menu');
          menu.open();
      }
      
      window.fn.load = function(page){
          var content = document.getElementById('content');
          var menu = document.getElementById('menu');
          
          content.load(page).then(menu.close.bind(menu));
      }
      
  </script>
  
  <script>
    document.addEventListener('init', function(e){
         var page = e.target;
        console.log(page.id);
          
          if(page.id === "carte"){
              
              function afficheMarkers(infoRecup, map){
                  
                  $.ajax({
                  url: 'https://theosenilh.fr/api_appli_creteil/json_coords.php',
                  method: 'GET',
                  data: {api_key: 'jdhey7te6', location_id: infoRecup},
                  dataType: 'json',
                 success: function(data){
                     
                     if(infoRecup === "all"){
                      map.setView([48.7942, 2.46172], 15);
                  } else {
                      map.setView([parseFloat(data[0].latitude_point_interet), parseFloat(data[0].longitude_point_interet)], 18);
                  }
                     
                     var json_autres_images = [];
                     
                     for(var i = 0; i < data.length; i++){
                         
                         var marker = L.marker([parseFloat(data[i].latitude_point_interet), parseFloat(data[i].longitude_point_interet)]);
                         
                         if(data[i].autres_images_point_interet !== ""){
                             
                             var tableau = JSON.parse(data[i].autres_images_point_interet);
                             
                             json_autres_images.push(tableau);
                         } else {
                             json_autres_images.push("");
                         }
                     
                     marker.bindPopup("<h1>"+ data[i].nom_point_interet +"</h1><img src=\""+ data[i].photo_point_interet +"\" width=\"100\" height=\"100\"><br><i>Adresse: </i><strong>"+ data[i].adresse_point_interet +"</strong><br><br><p>"+ data[i].description_point_interet +"</p><br>" + recupereDonnees(json_autres_images, i));
                     
                     marker.addTo(map);
                     }
                 } 
              });
              }
              
              function latLngMarker(infoRecup, map){
                  
                 return $.ajax({
                  url: 'https://theosenilh.fr/api_appli_creteil/json_coords.php',
                  method: 'GET',
                  data: {api_key: 'jdhey7te6', location_id: infoRecup},
                  dataType: 'json'
                  });
              }
              
              function recupereDonnees(tableau_images, index){
                  
                  var chaine = "";
                  
                  if(tableau_images){
                      if(tableau_images[index] !== ""){
                      for(var i = 0; i < tableau_images[index].length; i++){
                         chaine += "<img src=\""+ tableau_images[index][i] +"\" width=\"100\" height=\"100\">"; 
                      }
                  }
                  }
                  
                  return chaine;
              }
              
              function autocompleteSearch(requete, search, autoriseBoucle, map){
                  
                  var listItems = $(requete);
                  
                  console.log(listItems);
                  
                  if(autoriseBoucle){
                          listItems.on('click', function(){
                          search.val($(this).find(".center h1").text());
                              
                              afficheMarkers(parseInt($(this).find(".center p").text()), map);
                              
                          $('#places_list').html('');
                          
                      });
                  
                  }
              }
              
              
              var map = L.map('mapid');
              var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
              var osmAttrib = "Map data © OpenStreetMap contributors";
                  
                  var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
              
              map.addLayer(osm);
              
              afficheMarkers("all", map);
              
              var tinnedGps = {lat: 48.7942, lng: 2.46172};
              
              var controlGps = new L.Control.Gps({transform: function(realGps){
                return tinnedGps;  
              },
                  autoCenter: true, 
                    marker: L.circleMarker([tinnedGps.lat, tinnedGps.lng])});
              
              map.addControl(controlGps);
              
              $('ons-page ons-search-input').on('keyup', function(){
                 
                  var valeur = $('ons-page ons-search-input').val();

                  if(valeur !== ""){
                      $.ajax({
                     url: 'https://theosenilh.fr/api_appli_creteil/search_coords.php',
                      method: 'GET',
                      data: {api_key: "jdhey7te6", cherche: valeur},
                      dataType: 'json',
                      success: function(data){
                          
                          var chainehtml = "";
                          
                              if(data.length !== 0){
                              for(var i = 0; i < data.length; i++){
                              chainehtml += '<ons-list-item modifier="longdivider" tappable><h1>'+ data[i].nom_point_interet +'</h1><i>'+ data[i].adresse_point_interet +'</i><p style="display: none;">'+ data[i].id_point_interet +'</p></ons-list-item>';
                          }
                          } else {
                              chainehtml = '<ons-list-item modifier="longdivider"><p>Pas de correspondance</p></ons-list-item>';
                          }
                              $('#places_list').html(chainehtml);
                          autocompleteSearch('#places_list ons-list-item', $('ons-search-input'), (data.length !== 0), map);
                          
                      }
                  });
                      
                  } else {
                      $('#places_list').html("");
                  }
                  
                  
              });
                } else if(page.id === "parcours"){
                    
                    
                    function listeParcours(option){
                            return $.ajax({
                               url: "https://theosenilh.fr/api_appli_creteil/liste_parcours.php",
                                method: 'GET',
                                data: {api_key: "jdhey7te6", parcours_id: option},
                                dataType: 'json'
                            });
                        }
                    
                    listeParcours("all").done(function(data){
                        var chaine = "";
                        
                        $.each(data, function(i){
                            chaine += "<ons-list-item tappable tabindex=\""+ data[i].id_parcours +"\">"+ data[i].nom_parcours +"</ons-list-item>";
                        });
                        
                        $('ons-card').html(chaine);
                        
                     $('ons-list-item').on('click', function(){
                            document.querySelector('ons-navigator').pushPage('carte_parcours.html', {data: {id: $(this).attr('tabindex'), title: $(this).text()}});
                        });
                    });
                        
                        } else if(page.id === "carte_parcours"){
                            
                        $('ons-toolbar .center').text(page.data.title);
                        $('p').text(page.data.id);
                            
                            var map = L.map('map_parcours');
              var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
              var osmAttrib = "Map data © OpenStreetMap contributors";
                  
                  var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
              
              map.addLayer(osm);
                            
                            map.setView([48.7942, 2.46172], 15);
                            
                            $.ajax({
                               url: 'https://theosenilh.fr/api_appli_creteil/liste_points_interet_parcours.php',
                                method: 'GET',
                                data: {api_key: "jdhey7te6", parcours_id: parseInt(page.data.id)},
                                dataType: 'json',
                                success: function(data){
                                    
                                    console.log(data);
                                    
                                    var tableauWaypoints = [];
                                    
                                    $.each(data, function(i){
                                       tableauWaypoints.push(L.latLng(parseFloat(data[i].latitude_point_interet), parseFloat(data[i].longitude_point_interet))); 
                                    });
                                    
                                    console.log(tableauWaypoints);
                                    
                                    L.Routing.control({
                  waypoints: tableauWaypoints,
                          router: L.Routing.mapbox("pk.eyJ1IjoidGhlb2Rvcm9zIiwiYSI6ImNqb2sxdW01YTAyN28zb21uY21jeXMzY3cifQ._g5OAq0Wjfou_LsBW07TAQ", {profile: "mapbox/walking"}),
                  routeWhileDragging: true,
              }).addTo(map);
                                }
                            });
                            
                 }
    });
    </script>
  
</body>
</html>